# Merkle Patricia Verifier - JavaScript Implementation

JavaScript implementation of a Merkle Patricia Trie inclusion proof verifier, compatible with the Scala implementation in the Metakit project.

## Overview

This library provides functionality to verify Merkle Patricia inclusion proofs that are generated by the Scala backend. It implements the same verification logic as the Scala `MerklePatriciaVerifier` class.

## Installation

```bash
npm install
```

## Usage

### Basic Verification

```javascript
const { MerklePatriciaVerifier } = require('./merkle-patricia-verifier');

// Create a verifier with the root hash
const rootHash = "4bde493b43d66c45a381a3e18a6e4c840cfa550319e24f397fb1aa1ab35a7a71";
const verifier = new MerklePatriciaVerifier(rootHash);

// Verify a proof (typically received as JSON from the Scala backend)
const proof = {
  path: "185b77b8cc4daf5b7f9975b488bc6b8531b50f61f60910e8df6d33818e7c999f",
  witness: [
    // ... commitment nodes from leaf to root
  ]
};

const result = verifier.verify(proof);
if (result.success) {
  console.log('Proof is valid!');
} else {
  console.log('Proof is invalid:', result.error.message);
}
```

### Proof Structure

The proof JSON must have the following structure:

```json
{
  "path": "hex_string_of_the_key_hash",
  "witness": [
    {
      "type": "Leaf|Extension|Branch",
      "contents": {
        // Node-specific content
      }
    }
  ]
}
```

#### Commitment Types

1. **Leaf**: Terminal node containing data
   ```json
   {
     "type": "Leaf",
     "contents": {
       "remaining": "hex_nibbles",
       "dataDigest": "sha256_hash"
     }
   }
   ```

2. **Extension**: Optimization node for shared path prefixes
   ```json
   {
     "type": "Extension",
     "contents": {
       "shared": "hex_nibbles",
       "childDigest": "sha256_hash"
     }
   }
   ```

3. **Branch**: Node with multiple possible paths
   ```json
   {
     "type": "Branch",
     "contents": {
       "pathsDigest": {
         "0": "sha256_hash",
         "a": "sha256_hash",
         // ... up to 16 nibbles (0-f)
       }
     }
   }
   ```

## Testing

Run the test suite:

```bash
npm test
```

Run the example:

```bash
npm run example
```

## Implementation Details

### Hash Computation

The verifier uses SHA-256 for hash computation, matching the Scala implementation:
- JSON objects are serialized with sorted keys for consistency
- Binary prefixes are prepended to distinguish node types:
  - Leaf: `[0]`
  - Branch: `[1]`
  - Extension: `[2]`

### Nibbles

Paths in the trie are represented as sequences of nibbles (4-bit values):
- Each byte of a hash becomes two nibbles
- Nibbles are represented as hex characters (0-9, a-f)

### Verification Algorithm

1. Start with the root hash and full path
2. Process witness commitments in reverse order (root to leaf)
3. For each commitment:
   - Verify the commitment's hash matches the expected digest
   - Update the current digest and remaining path
4. At the leaf, verify the remaining path matches

## Error Types

- `InvalidWitness`: Malformed witness structure
- `InvalidPath`: Path mismatch or not found in branch
- `InvalidNodeCommitment`: Hash verification failure

## Compatibility

This implementation is designed to be compatible with:
- Scala Metakit `MerklePatriciaVerifier`
- JSON proofs exported from the Scala backend
- Standard SHA-256 hashing